---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const posts = await getCollection("posts");
posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const postsByYear: Record<number, typeof posts> = {};
for (const post of posts) {
  const year = post.data.date.getFullYear();
  if (!postsByYear[year]) postsByYear[year] = [];
  postsByYear[year].push(post);
}
const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);

function getExcerpt(body: string): string {
  const plain = body
    .replace(/^---[\s\S]*?---/, "")
    .replace(/!\[.*?\]\(.*?\)/g, "")
    .replace(/\[([^\]]+)\]\(.*?\)/g, "$1")
    .replace(/[#*>`_~]/g, "")
    .trim();
  const match = plain.match(/[^.!?]*[.!?]/);
  return match ? match[0].trim() : plain.slice(0, 120);
}
---

<BaseLayout title="Posts">
  <h1 class="page-title">Posts</h1>
  <section class="posts">
    {years.map((year) => (
      <div class="year-group">
        <h2 class="year">{year}</h2>
        <ul>
          {postsByYear[year].map((post) => (
            <li>
              <a href={`/posts/${post.id}/`}>
                <span class="post-title">{post.data.title}</span>
                <span class="post-excerpt">{getExcerpt(post.body ?? "")}</span>
              </a>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </section>
</BaseLayout>

<style>
  .page-title {
    font-size: 1.6rem;
    margin: 2rem 0 1.5rem;
  }

  .year {
    font-size: 1rem;
    color: var(--text-muted);
    font-weight: 400;
    margin-bottom: 0.8rem;
    letter-spacing: 0.1em;
  }

  .year-group { margin-bottom: 2rem; }
  ul { list-style: none; }
  li { margin-bottom: 1rem; }

  li a {
    display: block;
    padding: 0.6rem 0.8rem;
    border-radius: 4px;
  }

  li a:hover {
    background: var(--surface);
    text-decoration: none;
  }

  .post-title {
    display: block;
    color: var(--text-bright);
    font-size: 0.95rem;
    font-weight: 500;
  }

  .post-excerpt {
    display: block;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-top: 0.2rem;
  }
</style>
